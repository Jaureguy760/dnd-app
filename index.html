<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dungeon Maker - Dyson Style</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/controls.css">
  <link rel="stylesheet" href="css/modal.css">
</head>
<body>
<header>
  <div>
    <h1>Dungeon Maker - Dyson Style</h1>
    <small>Hand-drawn D&D maps | Drag rooms | Delete key to remove | Ctrl+Z to undo</small>
  </div>
  <div class="status" id="statusText">Auto-saved</div>
</header>

<!-- Level Navigation -->
<div class="level-navigation">
  <div class="level-tabs" id="levelTabs">
    <button class="level-tab active" data-level="0">
      Level 1
      <span class="level-depth">Ground</span>
    </button>
    <button class="level-tab-add" id="btnAddLevel">+ Add Level</button>
  </div>
  <div class="level-info">
    <input type="text" id="levelNameInput" placeholder="Level name..." value="Level 1">
    <button id="btnDeleteLevel" class="btn-small" disabled>Delete Level</button>
  </div>
</div>

<main class="layout">
  <!-- LEFT: MAP -->
  <section class="left">
    <div class="canvas-container" id="canvasContainer">
      <canvas id="mapCanvas" width="800" height="600"></canvas>
    </div>

    <div class="toolbar">
      <button id="newDungeonBtn" class="primary">New Random Dungeon</button>

      <label class="file-label">
        Load Map Image
        <input type="file" id="mapFileInput" accept="image/*">
      </label>

      <button id="placeMarkerBtn">Add Numbered Location</button>

      <label class="file-label">
        Import JSON
        <input type="file" id="jsonFileInput" accept="application/json">
      </label>

      <button id="exportPngBtn">Export Map PNG</button>
      <button id="exportJsonBtn">Export JSON</button>

      <div class="zoom-controls">
        <button id="zoomOutBtn">-</button>
        <span id="zoomLabel">100%</span>
        <button id="zoomInBtn">+</button>
        <button id="zoomResetBtn">Reset</button>
      </div>

      <button id="undoBtn" disabled>â†¶ Undo</button>
      <button id="redoBtn" disabled>â†· Redo</button>
      <button id="renumberBtn">Renumber Rooms</button>
    </div>

    <div class="options">
      <span>Render Style:</span>
      <select id="renderStyleSelect">
        <option value="modern">Modern Clean</option>
        <option value="dyson" selected>Hand-Drawn (Dyson)</option>
        <option value="vintage">TSR Vintage</option>
      </select>
      <span class="style-preview" id="stylePreview">âœ¨ Sketchy lines + cross-hatching</span>

      <span>Algorithm:</span>
      <select id="algorithmSelect">
        <option value="rooms">Classic Rooms</option>
        <option value="bsp">BSP Dungeon</option>
        <option value="caves">Cellular Caves</option>
      </select>

      <span>Size:</span>
      <select id="sizeSelect">
        <option value="small">Small</option>
        <option value="medium" selected>Medium</option>
        <option value="large">Large</option>
      </select>

      <span>Density:</span>
      <input id="densityRange" type="range" min="1" max="10" value="5">
      <span class="density-value" id="densityValue">5</span>

      <span>Theme:</span>
      <select id="themeSelect">
        <option value="classic">Classic Dungeon</option>
        <option value="undead">Undead Crypt</option>
        <option value="cavern">Caverns</option>
        <option value="arcane">Arcane Ruin</option>
      </select>
    </div>

    <div class="options">
      <span>Templates:</span>
      <select id="templateSelect">
        <option value="">-- Choose Template --</option>
        <option value="starter">Starter Cave</option>
        <option value="tower">Wizard's Tower</option>
        <option value="crypt">Ancient Crypt</option>
        <option value="mine">Abandoned Mine</option>
        <option value="castle">Castle Ruins</option>
      </select>
      <button id="loadTemplateBtn">Load Template</button>
      <button id="clearStorageBtn">Clear Auto-Save</button>
    </div>

    <div class="hint">
      ğŸ¨ Dyson Mode: Hand-drawn lines + cross-hatched walls + organic shapes. Switch to Modern for clean digital look.
    </div>

    <!-- SYMBOL PALETTE (Phase 2 + Phase 6 Expansion) -->
    <details style="margin-top: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; border: 1px solid #333;">
      <summary style="cursor: pointer; font-weight: bold; font-size: 0.9rem;">ğŸ”¨ Map Symbols</summary>

      <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
        <!-- Category Selector -->
        <div>
          <label style="font-size: 0.85rem; color: #aaa;">Category:</label>
          <select id="symbolCategorySelect" style="width: 100%; margin-top: 0.25rem;">
            <option value="basic">Basic (Doors/Stairs)</option>
            <option value="terrain">Terrain Features</option>
            <option value="interactive">Interactive Objects</option>
            <option value="containers">Containers</option>
            <option value="dressing">Room Dressing</option>
            <option value="natural">Natural Elements</option>
          </select>
        </div>

        <!-- Symbol Type (dynamically populated) -->
        <div>
          <label style="font-size: 0.85rem; color: #aaa;">Symbol:</label>
          <select id="symbolTypeSelect" style="width: 100%; margin-top: 0.25rem;">
            <!-- Populated by JavaScript -->
          </select>
        </div>

        <!-- Subtype (dynamically populated) -->
        <div>
          <label style="font-size: 0.85rem; color: #aaa;">Style:</label>
          <select id="symbolSubtypeSelect" style="width: 100%; margin-top: 0.25rem;">
            <!-- Populated by JavaScript -->
          </select>
        </div>

        <!-- Place Symbol Button -->
        <button id="btnPlaceSymbol" class="symbol-btn">Place Symbol on Map</button>
        <button id="btnAutoDetectDoors">ğŸ” Auto-Detect Doors</button>

        <div style="display: flex; gap: 0.25rem; margin-top: 0.25rem;">
          <button id="btnDeleteSymbol" disabled style="background: #5a2a2a; border-color: #844;">âŒ Delete Selected</button>
          <button id="btnClearSymbols">ğŸ—‘ï¸ Clear All</button>
        </div>

        <div id="symbolHint" style="font-size: 0.75rem; color: #888; font-style: italic;">
          Select category, symbol, and style, then click "Place Symbol" and click on the map.
        </div>
      </div>
    </details>

    <!-- MAP EFFECTS (Phase 3) -->
    <details style="margin-top: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; border: 1px solid #333;">
      <summary style="cursor: pointer; font-weight: bold; font-size: 0.9rem;">ğŸ¨ Map Effects</summary>

      <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem;">
        <label style="display: flex; gap: 0.5rem; align-items: center;">
          <input type="checkbox" id="chkTitleBlock" checked>
          ğŸ“œ Title Block
        </label>
        <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-left: 1.5rem;">
          <input type="text" id="dungeonNameInput" placeholder="Dungeon Name" value="The Lost Crypt" style="font-size: 0.8rem; padding: 0.25rem;">
          <input type="text" id="dmNameInput" placeholder="DM Name" value="DM" style="font-size: 0.8rem; padding: 0.25rem;">
        </div>

        <label style="display: flex; gap: 0.5rem; align-items: center;">
          <input type="checkbox" id="chkCompass" checked>
          ğŸ§­ Compass Rose
        </label>

        <label style="display: flex; gap: 0.5rem; align-items: center;">
          <input type="checkbox" id="chkCoffeeStains">
          â˜• Coffee Stains
        </label>

        <label style="display: flex; gap: 0.5rem; align-items: center;">
          <input type="checkbox" id="chkAgeSpots">
          ğŸŸ¤ Age Spots
        </label>

        <button id="btnRefreshEffects" style="margin-top: 0.25rem;">ğŸ”„ Regenerate Effects</button>
      </div>
    </details>

    <!-- PHASE 5: DM TOOLS -->
    <details style="margin-top: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; border: 1px solid #333;">
      <summary style="cursor: pointer; font-weight: bold; font-size: 0.9rem;">ğŸ² DM Tools</summary>

      <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem;">
        <!-- Measurement Ruler -->
        <button id="btnRulerMode">ğŸ“ Measure Distance</button>
        <div class="hint" id="rulerHint" style="display:none;">Click two points to measure</div>

        <!-- Text Annotations -->
        <button id="btnAddAnnotation">ğŸ“ Add Note</button>
        <button id="btnClearAnnotations">âœ• Clear All Notes</button>

        <!-- Traps -->
        <h4 style="margin-top: 1rem;">Traps</h4>
        <select id="trapTypeSelect">
          <option value="bear">ğŸª¤ Bear Trap</option>
          <option value="pit">ğŸ•³ï¸ Pit Trap</option>
          <option value="dart">ğŸ¯ Dart Trap</option>
          <option value="poison">â˜ ï¸ Poison Gas</option>
          <option value="spike">âš”ï¸ Spike Trap</option>
          <option value="fire">ğŸ”¥ Fire Trap</option>
          <option value="magic">âœ¨ Magical Trap</option>
        </select>
        <button id="btnPlaceTrap">Place Trap</button>
        <button id="btnClearTraps">âœ• Clear All Traps</button>

        <!-- Monsters/Encounters -->
        <h4 style="margin-top: 1rem;">Monsters</h4>
        <select id="encounterTypeSelect">
          <option value="humanoid">ğŸ§ Humanoid</option>
          <option value="beast">ğŸ» Beast</option>
          <option value="undead">ğŸ’€ Undead</option>
          <option value="dragon">ğŸ‰ Dragon</option>
          <option value="fiend">ğŸ˜ˆ Fiend</option>
          <option value="aberration">ğŸ‘ï¸ Aberration</option>
        </select>
        <button id="btnPlaceEncounter">Place Monster</button>
        <button id="btnClearEncounters">âœ• Clear All Monsters</button>

        <!-- DM Notes Layer -->
        <h4 style="margin-top: 1rem;">DM Notes</h4>
        <label>
          <input type="checkbox" id="chkShowDmNotes" checked> Show DM Notes
        </label>
        <button id="btnAddDmNote">Add Secret Note</button>
        <button id="btnClearDmNotes">âœ• Clear DM Notes</button>

        <!-- Treasure Generation -->
        <h4 style="margin-top: 1rem;">ğŸ’° Treasure</h4>
        <button id="btnOpenTreasure">ğŸ² Generate Loot</button>
      </div>
    </details>

    <!-- PHASE 6: ENVIRONMENTAL HAZARDS -->
    <details style="margin-top: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; border: 1px solid #333;">
      <summary style="cursor: pointer; font-weight: bold; font-size: 0.9rem;">ğŸŒŠ Environmental Hazards</summary>

      <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem;">
        <label>Terrain Type:</label>
        <select id="terrainTypeSelect">
          <option value="water">ğŸ’§ Water (difficult terrain)</option>
          <option value="lava">ğŸ”¥ Lava (4d10 fire/turn)</option>
          <option value="pit">ğŸ•³ï¸ Pit (10ft fall, 1d6)</option>
          <option value="difficult">ğŸŒ¿ Difficult Terrain (Â½ speed)</option>
          <option value="darkness">ğŸŒ‘ Darkness (heavily obscured)</option>
          <option value="ice">â„ï¸ Ice (DC 10 Dex save)</option>
          <option value="poison">â˜ ï¸ Poison Gas (DC 12 Con save)</option>
        </select>

        <label>Brush Size:</label>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="range" id="terrainBrushSize" min="1" max="5" value="2" style="flex: 1;">
          <span id="brushSizeLabel" style="min-width: 50px;">2 grid</span>
        </div>

        <button id="btnPaintTerrain">ğŸ–Œï¸ Paint Mode</button>
        <button id="btnEraseTerrain">ğŸ§¹ Erase Terrain</button>
        <button id="btnClearAllTerrain">âœ• Clear All</button>
      </div>
    </details>
  </section>

  <!-- RIGHT: ROOM LIST -->
  <section class="right">
    <h2>Numbered Locations</h2>
    <small>Click a room on the map or in the list to edit its text.</small>
    <ol id="roomList"></ol>
  </section>
</main>

<!-- EXPORT MODAL (Phase 4) -->
<div id="exportModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ“¤ Export Dungeon</h2>
      <button class="modal-close" id="btnCloseExport">Ã—</button>
    </div>

    <div class="export-grid">
      <!-- Left: Options -->
      <div>
        <div class="export-section">
          <h3>ğŸ¨ Visual Style</h3>
          <label>
            <input type="radio" name="exportStyle" value="modern"> Modern Clean
            <span class="style-desc">Crisp digital lines, solid colors</span>
          </label>
          <label>
            <input type="radio" name="exportStyle" value="dyson" checked> Hand-Drawn (Dyson)
            <span class="style-desc">Sketchy lines, cross-hatched walls</span>
          </label>
          <label>
            <input type="radio" name="exportStyle" value="vintage"> TSR Vintage
            <span class="style-desc">Classic blue grid style</span>
          </label>
        </div>

        <div class="export-section">
          <h3>ğŸ“ Layout</h3>
          <label>
            <input type="radio" name="exportLayout" value="map-only" checked> Map Only
            <span class="style-desc">Just the dungeon map</span>
          </label>
          <label>
            <input type="radio" name="exportLayout" value="map-key"> Map + Room Key
            <span class="style-desc">Map on left, descriptions on right</span>
          </label>
        </div>

        <div class="export-section">
          <h3>ğŸ” Resolution</h3>
          <label>
            <input type="radio" name="exportRes" value="1" checked> Standard (800Ã—600)
            <span class="style-desc">Screen viewing, web sharing</span>
          </label>
          <label>
            <input type="radio" name="exportRes" value="2"> High Quality (1600Ã—1200)
            <span class="style-desc">High-DPI screens, VTTs</span>
          </label>
          <label>
            <input type="radio" name="exportRes" value="4"> Print Quality (3200Ã—2400)
            <span class="style-desc">Physical printing, large displays</span>
          </label>
        </div>

        <div class="export-section">
          <h3>âš™ï¸ Options</h3>
          <label>
            <input type="checkbox" id="exportIncludeEffects" checked> Include visual effects
          </label>
          <label>
            <input type="checkbox" id="exportShowGrid"> Show grid overlay
          </label>
          <label>
            <input type="checkbox" id="exportIncludeDmNotes"> Include DM Notes (for DM map)
          </label>

          <h4 style="margin-top: 1rem;">Multi-Level</h4>
          <label>
            <input type="checkbox" id="exportAllLevels"> Export all levels (separate files)
          </label>
          <label>
            <input type="checkbox" id="exportIncludeLevelName" checked> Include level name in filename
          </label>
        </div>
      </div>

      <!-- Right: Preview -->
      <div>
        <div class="export-section">
          <h3>ğŸ‘ï¸ Preview</h3>
        </div>
        <div class="export-preview">
          <canvas id="exportPreviewCanvas" width="400" height="300"></canvas>
          <p class="export-info" id="exportInfo">800Ã—600 @ 1x | ~120 KB</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button id="btnExecuteExport" class="btn-large primary">ğŸ“¥ Download PNG</button>
      <button id="btnCancelExport" class="btn-large">Cancel</button>
    </div>
  </div>
</div>

<!-- TRAP DETAILS MODAL -->
<div id="trapModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸª¤ Trap Details</h2>
      <button class="modal-close" id="btnCloseTrap">Ã—</button>
    </div>
    <div style="padding: 1rem;">
      <label>Detection DC: <input type="number" id="trapDetectionDC" value="15" min="1" max="30"></label><br>
      <label>Disarm DC: <input type="number" id="trapDisarmDC" value="13" min="1" max="30"></label><br>
      <label>Save Type:
        <select id="trapSaveType">
          <option>Dexterity</option>
          <option>Constitution</option>
          <option>Wisdom</option>
        </select>
      </label><br>
      <label>Damage: <input type="text" id="trapDamage" placeholder="2d10 piercing"></label><br>
      <label>Description:<br>
        <textarea id="trapDescription" rows="3" style="width: 100%;"></textarea>
      </label>
    </div>
    <div class="modal-footer">
      <button id="btnSaveTrap" class="btn-large primary">Save Trap</button>
      <button id="btnCancelTrap" class="btn-large">Cancel</button>
    </div>
  </div>
</div>

<!-- ENCOUNTER DETAILS MODAL -->
<div id="encounterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ‘¹ Monster Details</h2>
      <button class="modal-close" id="btnCloseEncounter">Ã—</button>
    </div>
    <div style="padding: 1rem;">
      <label>Name/Type: <input type="text" id="encounterName" placeholder="Goblin"></label><br>
      <label>Count: <input type="number" id="encounterCount" value="1" min="1" max="20"></label><br>
      <label>AC: <input type="number" id="encounterAC" value="13" min="1" max="30"></label><br>
      <label>HP (each): <input type="text" id="encounterHP" placeholder="7"></label><br>
      <label>Difficulty:
        <select id="encounterDifficulty">
          <option value="easy">Easy (Green)</option>
          <option value="medium">Medium (Yellow)</option>
          <option value="hard">Hard (Red)</option>
        </select>
      </label><br>
      <label>Behavior:<br>
        <textarea id="encounterBehavior" rows="2" placeholder="Patrol, alert on 5+" style="width: 100%;"></textarea>
      </label><br>
      <label>Notes:<br>
        <textarea id="encounterNotes" rows="2" placeholder="Additional notes" style="width: 100%;"></textarea>
      </label>
    </div>
    <div class="modal-footer">
      <button id="btnSaveEncounter" class="btn-large primary">Save Monster</button>
      <button id="btnCancelEncounter" class="btn-large">Cancel</button>
    </div>
  </div>
</div>

<!-- STAIR LINKING MODAL -->
<div id="stairLinkModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸªœ Stair Destination</h2>
      <button class="modal-close" id="btnCloseStairLink">Ã—</button>
    </div>
    <div style="padding: 1rem;">
      <p>Where does this stair lead?</p>

      <label>
        <input type="radio" name="stairDest" value="new" checked>
        Create new level (auto-link)
      </label>
      <br>

      <label>
        <input type="radio" name="stairDest" value="existing">
        Link to existing level:
        <select id="stairDestLevel" disabled>
          <!-- Dynamically populated -->
        </select>
      </label>
      <br>

      <label>
        <input type="radio" name="stairDest" value="none">
        No link (decorative)
      </label>

      <p class="hint" id="stairLinkHint" style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;">A new level will be created with a linked stair.</p>
    </div>
    <div class="modal-footer">
      <button id="btnSaveStairLink" class="btn-large primary">Create Stair</button>
      <button id="btnCancelStairLink" class="btn-large">Cancel</button>
    </div>
  </div>
</div>

<!-- TREASURE GENERATOR MODAL -->
<div id="treasureModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2>ğŸ’° Treasure Generator</h2>
      <button class="modal-close" id="treasureModalClose">Ã—</button>
    </div>

    <div style="padding: 1rem;">
      <label>
        <strong>Challenge Rating:</strong>
        <input type="number" id="treasureCR" min="0" max="30" value="5" style="width: 60px;">
      </label>

      <div style="margin-top: 0.5rem;">
        <label><input type="checkbox" id="treasureIncludeCoins" checked> Coins</label>
        <label><input type="checkbox" id="treasureIncludeGems" checked> Gemstones</label>
        <label><input type="checkbox" id="treasureIncludeArt" checked> Art Objects</label>
        <label><input type="checkbox" id="treasureIncludeMagic" checked> Magic Items</label>
      </div>
    </div>

    <div style="padding: 0 1rem;">
      <button id="btnGenerateTreasure" style="padding: 0.75rem 1.5rem; font-size: 1.1rem;">
        ğŸ² Generate Loot
      </button>
      <button id="btnRerollTreasure" style="padding: 0.75rem 1.5rem; margin-left: 0.5rem;">
        ğŸ”„ Re-roll
      </button>
    </div>

    <div id="treasureOutput" style="margin: 1rem; padding: 1rem; background: #2a2a2a; border-radius: 4px; min-height: 200px; white-space: pre-wrap; font-family: monospace; font-size: 0.9rem;">
      Click "Generate Loot" to create treasure!
    </div>

    <div class="modal-footer">
      <button id="btnCopyTreasure">ğŸ“‹ Copy to Clipboard</button>
      <button id="btnAddTreasureToDmNotes">ğŸ“ Add to DM Notes</button>
    </div>
  </div>
</div>

<script type="module" src="js/main.js"></script>
</body>
</html>
